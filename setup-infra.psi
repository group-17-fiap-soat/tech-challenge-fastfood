# setup-fastfood.ps1
$ErrorActionPreference = "Stop"

function Install-Kubectl {
    Write-Host "ğŸ”§ Instalando kubectl..."
    $kubectlUrl = "https://dl.k8s.io/release/v1.29.0/bin/windows/amd64/kubectl.exe"
    Invoke-WebRequest -Uri $kubectlUrl -OutFile "$PWD\kubectl.exe"
    Move-Item "$PWD\kubectl.exe" "C:\Windows\System32\kubectl.exe" -Force
    Write-Host "âœ… kubectl instalado."
}

function Install-Minikube {
    Write-Host "ğŸ”§ Instalando minikube..."
    $minikubeUrl = "https://storage.googleapis.com/minikube/releases/latest/minikube-windows-amd64.exe"
    Invoke-WebRequest -Uri $minikubeUrl -OutFile "$PWD\minikube.exe"
    Move-Item "$PWD\minikube.exe" "C:\Windows\System32\minikube.exe" -Force
    Write-Host "âœ… minikube instalado."
}

# Verificar kubectl
if (-not (Get-Command kubectl -ErrorAction SilentlyContinue)) {
    Install-Kubectl
} else {
    Write-Host "âœ… kubectl jÃ¡ estÃ¡ instalado."
}

# Verificar minikube
if (-not (Get-Command minikube -ErrorAction SilentlyContinue)) {
    Install-Minikube
} else {
    Write-Host "âœ… minikube jÃ¡ estÃ¡ instalado."
}

# Iniciar o minikube
Write-Host "`nğŸš€ Iniciando o Minikube..."
minikube start

# Configurar Docker dentro do Minikube
Write-Host "`nğŸ³ Configurando ambiente Docker com Minikube..."
Invoke-Expression -Command "$(minikube docker-env | Out-String)"

# Fazer build das imagens
Write-Host "`nğŸ”¨ Build das imagens Docker..."
docker build -f infra/db/Dockerfile -t fastfood-postgres:latest .
docker build -t tech-challenge-fastfood:latest .

# Aplicar YAMLs do k8s
Write-Host "`nğŸ“¦ Aplicando manifests do Kubernetes (.\k8s\)..."
kubectl apply -f .\k8s\

# Abrir painel do Kubernetes
Write-Host "`nğŸ“Š Abrindo o Dashboard do Kubernetes..."
minikube dashboard
